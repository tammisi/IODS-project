---
title: "Chapter 6"
author: "Silja Tammi"
date: "12/8/2023"
output: html_document
---

# Chapter 6

```{r, include=FALSE}
# Load libraries
library(tidyverse)
library(dplyr)
library(ggplot2)
library(lme4)
```

## 1. Meet and Repeat: PART I using the RATS data

RATS data has been converted into long format in meet_and_repeat.R, so I import the data:

```{r}
RATSL <- read.table("./data/RATSL.txt", header = T)

# convert ID and Group into factors
RATSL$ID <- factor(RATSL$ID)
RATSL$Group <- factor(RATSL$Group)

# Draw ggplot with `Time` on the x-axis and `Weight` on the y-axis
ggplot(RATSL, aes(x = Time, y = Weight, linetype = ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:10, times=20)) +
  facet_grid(. ~ Group, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(limits = c(min(RATSL$Weight), max(RATSL$Weight)))

```

Next, we inspect the tracking to see if rats that have higher weight values at the beginning tend to have higher values throughout the study. 

The tracking phenomenon can be seen more clearly in a plot of the standardized values of each
observation, i.e., the values obtained by subtracting the relevant occasion mean from the original observation and then dividing by the corresponding visit standard deviation:

$$standardised(x) = \frac{x - mean(x)}{ sd(x)}$$
```{r}
# Group by WD and standardise the variable Weight
RATSL <- RATSL %>%
  group_by(WD) %>%
  mutate(stdweight = scale(Weight)) %>%
  ungroup()

# Plot again with the standardised Weight
ggplot(RATSL, aes(x = Time, y = stdweight, linetype = ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:10, times=20)) +
  facet_grid(. ~ Group, labeller = label_both) +
  scale_y_continuous(name = "standardized weight")
```

Let'sproduce graphs showing average (mean) profiles for each group along with some indication of the variation of the observations at each time point, in this case the standard error of mean

$$se = \frac{sd(x)}{\sqrt{n}}$$

```{r}
# Number of subjects (per group):
unique(RATSL$Group) # 3 groups
length(which(RATSL$Group ==1))
length(which(RATSL$Group ==2))
length(which(RATSL$Group ==3))
# n <- 20

library(dplyr)
library(tidyr)
# Summary data with mean and standard error of Weight by Group and Time 
RATSS <- RATSL %>%
  group_by(Group, Time) %>%
  summarise( mean = mean(Weight), se = sd(Weight) ) %>%
  ungroup()

# Plot the mean profiles
ggplot(RATSS, aes(x = Time, y = mean, linetype = Group, shape = Group)) +
  geom_line() +
  scale_linetype_manual(values = c(1,2,3)) +
  geom_point(size=3) +
  scale_shape_manual(values = c(1,2,3)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, linetype="1"), width=0.3) +
  theme(legend.position = c(0.9,0.4)) +
  scale_y_continuous(name = "mean(Weight) +/- se(Weight")

```
Next let's check for possible outliers

```{r}
# Create a summary data by Group and ID with mean as the summary variable
RATSL8S <- RATSL %>%
  group_by(Group, ID) %>%
  summarise(mean=mean(Weight) ) %>%
  ungroup()

ggplot(RATSL8S, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(Weight), Days 1-64")

# Create a new data by filtering the outlier and adjust the ggplot code the draw the plot again with the new data
RATSL8S1 <- RATSL8S[-12, ]

ggplot(RATSL8S1, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(Weight), Days 1-64")
```

T for test and A for Anova

```{r}

# Add the baseline from the original data as a new variable to the summary data
# RATSL8S2 <- RATSL8S %>%
#  mutate(baseline = RATS$WD1)

# Fit the linear model with the mean as the response 
# fit <- lm(mean ~ baseline + Group, data = RATSL8S2)

# Compute the analysis of variance table for the fitted model with anova()
# anova(fit)

# create a random intercept and random slope model
library(lme4)
RATS_ref <- lmer(Weight ~ Time + Group + (1 | ID), data = RATSL, REML = FALSE)
RATS_ref1 <- lmer(Weight ~ Time + Group + (Time | ID), data = RATSL, REML = FALSE)
summary(RATS_ref1)

# perform an ANOVA test on the two models
anova(RATS_ref1, RATS_ref)
```

## 2. Meet and Repeat: PART II using the BPRS data

```{r}
BPRSL <- read.table("./data/BPRSL.txt", header = T)

# convert ID and Group into factors
BPRSL$treatment <- factor(BPRSL$treatment)
BPRSL$subject <- factor(BPRSL$subject)


# Draw the plot
ggplot(BPRSL, aes(x = week, y = bprs, linetype = subject)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:10, times=4)) +
  facet_grid(. ~ treatment, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(limits = c(min(BPRSL$bprs), max(BPRSL$bprs)))

```

The bprs values seem to decrease in both treatment groups during the treatment weeks 1-8, but there doesn't seem to be significant differences between the groups.

Let's fit a multiple linear regression model to see if this is indeed correct.

```{r}
# fit a multiple linear regression model with `pbrs` as response and `week` and `treatment` as explanatory variables

# create a regression model RATS_reg
BPRSL_reg <- lm(data=BPRSL, bprs ~ week + treatment)

# print out a summary of the model
summary(BPRSL_reg)
```

In the summary we can see that time (week) is statistically significantly (p-value <2e-16) negatively correlated with pbrs value, so during treatment weeks 1-8 the bprs value goes down. However, the type of treatment (treatment) is not statistically significant, so the type of treatment doesn't have an effect on the decrease of pbrs value, as could be inspected from the plot above. 

The lm model assumes independence of the repeated measures of bprs, and this assumption is highly unlikely. So, now we will move on to consider both some more appropriate graphics and appropriate models.

To begin the more formal analysis of the bprs data, we will first fit the *random intercept model* for the same two explanatory variables: `week` and `treatment`. Fitting a random intercept model allows the linear regression fit for each study subject to differ in *intercept* from other subjects.

```{r}
# Create a random intercept model as subject as the random effect
BPRS_ref <- lmer(bprs ~ week + treatment + (1 | subject), data = BPRSL, REML = FALSE)

# Print the summary of the model
summary(BPRS_ref)
```

We see here again that treatment and time don't correlate with each other. The t value for treatment is close to zero (0.532), so it's p-value is large, whereas the t-statistic for week is far from zero (-10.896) with corresponding small p-value, which indicates that it is unlikely to get such results by chance and that the null hypothesis of no correlation between time and bprs should be rejected.
VARIABILITY!

Now we can move on to fit the *random intercept and random slope model* to the BPRS data. Fitting a random intercept and random slope model allows the linear regression fits for each individual to differ in intercept but also in slope. This way it is possible to account for the individual differences in the bprs profiles, but also the effect of time.

```{r}
# create a random intercept and random slope model with `week` and `subject` as the random effects
BPRS_ref1 <- lmer(bprs ~ week + treatment + (week | subject), data = BPRSL, REML = FALSE)

# print a summary of the model
summary(BPRS_ref1)

# Compute the ANOVA analysis of variance tables of the models `RATS_ref` and `RATS_ref1
anova(BPRS_ref1, BPRS_ref)
```

BPRS_ref1 (a random intercept and random slope model) is better than BPRS_ref (a random intercept model) in terms of chi-squared statistics (7.2721) and p-value of the likelihood ratio test (0.02636)
So the fit of BPRS_ref1 with both random intercept and random slope is better than the fit of BPRS_ref with only rendom intercept.

Finally, we can fit a random intercept and slope model that allows for a treatment group Ã— time interaction, even though we saw that treatment and time don't correlate with each other.

```{r}
# Write the same model as in the previous exercise but add `week` * `treatment` interaction.
BPRS_ref2 <- lmer(bprs ~ week + treatment + (week | subject) + (week * treatment), data = BPRSL, REML = FALSE)

# print a summary of the model
summary(BPRS_ref2)

# perform an ANOVA test on the two models
anova(BPRS_ref2, BPRS_ref1)
```

As could be expected, the model with the week * treatment interaction variable is not statistically better than the model without interaction (chi-squared statistic 3.1712, p-value 0.07495). So here the addition of the interaction was not necessary and didn't improve the model.